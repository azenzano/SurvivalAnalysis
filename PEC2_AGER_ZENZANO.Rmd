---
title: 'Análisis de Supervivencia'
subtitle: 'PEC2'
author: "Ager Zenzano Sarasola - UOC"
date: "14 de mayo de 2022"
output:
  bookdown::pdf_document2:
     keep_tex: no #se puede poner yes
     number_sections: yes
     toc: False #list of content
     toc_depth: 3
     fig_caption: yes
     fig_height: 3.8
     fig_width: 6.0
bibliography: bibliography.bib     
link-citations: yes
figurelist: yes
header-includes:
- \usepackage{mathrsfs}       # To include mathsrc fonts
- \usepackage{float}          # To insert figures caption
- \floatplacement{figure}{H}  # To insert figures caption
- \floatplacement{table}{H}
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \fancyhead[CE,CO]{\leftmark}
- \fancyfoot[LE,RO]{\thepage}
- \usepackage[ruled,vlined,linesnumbered]{algorithm2e}
- \usepackage{amsmath} 
- \usepackage[format=plain,labelfont={bf,it},labelfont={color=blue},textfont=it]{caption}
- \usepackage[backend=biber, style=alphabetic, citestyle=authortitle]{biblatex}
- \usepackage{sectsty}
- \sectionfont{\clearpage}
- \usepackage{sectsty} # a pagebreak for every top level heading
- \sectionfont{\clearpage} #a pagebreak for every top level heading
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE)
```

```{r}
library(dplyr)
library(survival)
library("survival")
library("survminer")
library(survMisc)
library(ggplot2)
library('grid')
library('gridExtra')
library('survival')
library(survminer)
#library(tidyr)
library("knitr")


```




```{r}
setwd("/Users/silmo/2_MASTER/Máster UOC/Analisis de Supervivencia/PEC2_20220523")
df_orig <- read.table("./whas500.dat")
```





```{r}
df_orig <- df_orig %>%
            dplyr::rename(id=V1,
                   age=V2,
                   gender=V3, #0=male, 1=female
                   hr=V4, #initial heartrate
                   diasbp=V6, #mmHg
                   bmi=V7, #km/m2
                   cvd=V8, #0=no, 1=yes
                   chf=V11, #0=no, 1=yes
                   miord=V13, #0=first, 1=recurrent
                   mitype=V14, #non Q-wave, 1=Q-wave
                   lenfol=V21, #Total length of follow-up: 
                                  #Days between Date of Last Follow-up and 
                                  #Hospital Admission Date
                   fstat=V22, #status 0=Alive, 1=Dead
                   )%>%
            mutate(
                  gender=factor(gender),
                  cvd=factor(cvd),
                  miord=factor(miord),
                  mitype=factor(mitype),
                  gender=factor(gender),
                  fstat=(fstat)
                   )
```





# A) 

**Estimad el modelo de riesgos proporcionales que contiene las variables género, edad (centrada en los 65 años, o sea como 0 los 65 años, i.e. edad-65) y la interacción género-edad. Estimad (de forma puntual y por intervalo) e interpretad el riesgo relativo para el efecto del género (1 versus 0) a cada edad.**

A continuación centramos la edad en 65 años y seleccionamos esta variable, `age65` junto `gender`, `fstat` y `lenfol`.

```{r echo=TRUE}
df_a <- df_orig %>%
            mutate(age65 = age - 65) %>%
            select(age65, gender,fstat,lenfol)
```

Ahora mediante la función `coxph` estimamos el modelo de riesgos proporcionales con las variables arriba mencionadas.

```{r echo=TRUE}
Y=Surv(df_a$lenfol,df_a$fstat)
mod_cox_a=coxph(Y~ gender + age65 + gender*age65, data=df_a)
```

```{r}
mod_cox <- mod_cox_a
```

Una vez ajustado el modelo Cox (ver Tabla \@ref(tab:tAcox)) si nos fijamos en el `p-valor` vemos que la variable `gender` no es significativa, en cambio la variable `age65` sí que es significativa y la interacción `gender*age65` también.

```{r tAcox}
tt_cox_a <- summary(mod_cox_a)
kable(tt_cox_a$coefficients, booktabs = T, caption = "Resultado del modelo Cox con las variables del apartado A)")
```

A partir del modelo Cox, con los coeficientes estimados hallamos el riesgo relativo de forma puntual y por intervalo. La dificultad a la hora de calcular el riesgo relativo (HR) en este modelo reside en la interacción 'gender*age65'. Por tanto, el riesgo relativo par este modelo lo podríamos representar tal que:

\begin{equation}\label{eq:eqAhr}
\hat{HR}=exp[\hat{l}],
\end{equation}

\begin{equation}\label{eq:eqAl}
  l=\beta_{1}+\beta_{3}age65,
\end{equation}

y los intervalos de confianza al 95%

\begin{equation}\label{eq:eqAci}
  exp[\hat{l}\pm1.96\sqrt{Var(\hat{l})}],
\end{equation}

donde

\begin{equation}\label{eq:eqAvar}
  Var(\hat{l})=Var(\hat{\beta_{1}})+ (age65)^2Var(\hat{\beta_{3}})+2(age65)Cov(\hat{\beta_{1}}\hat{\beta_{3}}).
\end{equation}

Para realizar el cálculo estimado de la varianza se debe de considerar las varianzas y covarianzas de los coeficientes estimados. Esto se debe a que a los coeficientes en la suma lineal son estimados a partir del mismo dataset y por consiguiente estos coeficientes están correlacionados [@KleinbaumDavidG2005Sa].

En la Tabla \@ref(tab:tAcoeff) mostramos los coeficientes y en la Tabla \@ref(tab:tAmatvar) las varianzas y covarianzas que utilizaremos en las ecuaciones para calcular la varianza y los intervalos de confianza.
 
```{r tAcoeff}
kable(data.frame(Coeficientes=mod_cox_a$coefficients), booktabs = T, caption = "Coeficientes del modelo Cox ajustado en el apartado A).")
```

```{r tAmatvar}
kable(mod_cox_a$var, booktabs = T, caption = "Matriz de covarianzas obtenida a partir del modelo Cox ajustado en el apartado A).")
```

```{r}
mod_cox <- mod_cox_a
```

A continuación mostramos la implementación de las Ecuaciones \eqref{eq:eqAhr}, \eqref{eq:eqAl}, \eqref{eq:eqAci} y \eqref{eq:eqAvar} en la siguiente función:

```{r echo=TRUE}
f_ci <- function(mod_cox,v_param){
         l = (mod_cox$coefficients[1]+(mod_cox$coefficients[3])*v_param)
         var_l = mod_cox$var[1,1] + 
                (v_param)^2 * mod_cox$var[3,3] + 
                (2*(v_param*mod_cox$var[1,3]))
         
         hr = exp(l)
         ci_inf = exp(l-1.96*sqrt(var_l))
         ci_sup = exp(l+1.96*sqrt(var_l))
         ci = cbind(v_param,hr, ci_inf, ci_sup)
         return(ci)
 }
```

```{r comment=NA}
#(v_param=unique(df_a$age65))
v_param=seq(-20,40,1)

```

```{r}
df_hr_ci <- data.frame(f_ci(mod_cox_a,v_param))
colnames(df_hr_ci) <- c("age65","hr","ci_inf","ci_sup")
```


A continuación, en la Figura \@ref(fig:plrl) mostramos para cada valor de 'age65', desde -20 hasta 40, el valor de riesgo relativo, $HR$ junto con los intervalos obtenidos.


```{r}
age65_limit = round(- mod_cox$coefficients[[1]]/mod_cox$coefficients[[3]])
```

```{r plrl, fig.cap = "Riesgo relativo, HR de forma puntual y por intervalo.", fig.width=5, fig.height=4}

pl_hr_ci <- ggplot(data=df_hr_ci) +
      geom_line(aes(x=age65,y=hr,color="HR")) +
      geom_line(aes(x=age65,y=ci_inf,color="CI"),linetype = "dashed") + 
      geom_line(aes(x=age65,y=ci_sup,color="CI"),linetype = "dashed") +
      geom_segment(aes(x = -20, y = 1, xend = 40, yend = 1), color="pink", linetype="dotted", size=0.20) +
      geom_segment(aes(x = age65_limit, y = 0, xend = age65_limit, yend = 1), color="pink", linetype="dotted", size=0.20) +
      scale_color_manual(values = c('HR' = 'black', 'CI' = 'gray')) +
      labs(x="age65", y="HR", colour='') +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_hr_ci
```

De la Figura \@ref(fig:plrl) ($gender: 0=hombre, 1=mujer$) y teniendo en cuenta las Ecuaciones \eqref{eq:eqAhr} y \eqref{eq:eqAl} podemos deducir que por ejemplo un hombre de 55 años ($age65=-10$) tiene menor riesgo relativo (`HR`) que una mujer con la misma edad. En cambio, una mujer de 85 años ($age65=20$)  tiene menor riesgo relativo (`HR`) que un hombre de la misma edad. Podemos tomar como referencia la linea rosa pintada en la Figura \@ref(fig:plrl). La linea rosa vertical señala el punto en la que la variable `age65` indica que no hay diferencia significativa en el riesgo relativo (`HR`) entre hombre y mujer. Este punto es $age65=$ `r age65_limit`, y se puede obtener de la siguiente manera:

```{r echo=TRUE}
age65_limit = - mod_cox$coefficients[[1]]/mod_cox$coefficients[[3]]
```


# B) 

**Añadid al modelo anterior, sean o no significativas, el tipo de IM, el orden de IM, la interacción tipo IM-orden IM, el ritmo cardíaco (centrado en 85 pulsaciones por minuto) y el indicador de complicaciones cardíacas. Calculad, representad e interpretad la función de supervivencia basal. (Nota: no hace falta validar la hipótesis de riesgos proporcionales)**

```{r}
df_b <- df_orig %>%
          mutate(age65=age-65, hr85=hr-85) %>%
          select(age65, gender,hr85,cvd,miord,mitype,fstat,lenfol)
```

A continuación, calculamos el modelo añadiendo añadiendo las variables `mitype`, el `miord`, la interacción `miord*mitype`, el `hr85` (ritmo cardíaco centrado en 85 pulsaciones por minuto) y el `cvd`.

```{r echo=TRUE}
Y = Surv(df_a$lenfol,df_a$fstat)
mod_cox_b = coxph(Y ~ age65 + gender + hr85 + cvd + miord + mitype +
                  gender*age65 + miord*mitype,
                  data=df_b, method="breslow")

```

```{r}
mod_cox_b_res = summary(mod_cox_b)
```

En la Tabla \@ref(tab:tBcoeff)  mostramos el resultado del modelo Cox ajustado y vemos que las covariables `age65`, `hr85` y la interacción `gender*age65` son significativas pero el resto no.
 
```{r tBcoeff}
kable(mod_cox_b_res$coefficients, booktabs = T, caption = "Resultado del modelo Cox ajustado con las variables del apartado B).")
```

En la Tabla \@ref(tab:tBstats)  mostramos los resultados del estadístico para el modelo ajustado y vemos que tenemos un buen ajuste con un `p-valor < 0.05`.

```{r tBstats}
kable(data.frame(Likelihood=mod_cox_b_res$logtest), booktabs = T, caption = "Estadístico Likelihood del modelo Cox con las variables del apartado B).")
```

A continuación, preparamos los valores de entrada para la covariantes del modelo en un nuevo dataset para calcular la función de supervivencia basal.
```{r echo=TRUE}
df_basal = data.frame(age65=0, gender='0', hr85=0, cvd='0', miord='0', mitype='0')
```

```{r}
s <- survfit(mod_cox_b, newdata = df_basal)
dt_s <- data.frame(time=summary(s)$time, surv=summary(s)$surv, lower=summary(s)$lower, upper=summary(s)$upper)

#plot(s,conf.int=T,main="Supervivencia basal")
```

```{r plBsbasal, fig.cap = "Supervivencia basal del modelo Cox con las variables del apartado B.", fig.width=5, fig.height=4}
ggsurvplot(dt_s,
           surv.median.line = "hv",
           conf.int.style = "step",
           palette ="black",
           legend.labs =  "S basal",
           legend.title="",
           ylab="Probabilidad de supervivencia, S",
           xlab="Tiempo",
           size = 0.1,
           conf.int = TRUE,
           font.legend = c(10),
           font.y = c(9),font.x = c(9),font.tickslab = c(9)
           ) +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))
```

En la Figura \@ref(fig:plBsbasal), vemos que para el individuo basal $age65=0$ (age=65), $gender=0$ (hombre), $hr85=0$ (hr=85), $cvd=0$ (sin historial cardíaco), $miord=0$ (primera vez), $mitype=0$ (sin ondas Q), la probabilidad de supervivencia $S$ es superior a 0.60 incluso hasta $Tiempo = 2160$.

# C) 

**Representad la función de supervivencia estimada para el modelo del apartado anterior, para cada tipo IM y orden IM (cuatro posibilidades). Interpretad los resultados.**

```{r}
df_c <- df_b
```

A continuación preparamos los nuevos datos de entrada para las covariantes incluidas en el modelo de apartado anterior B).
```{r echo=TRUE}
df_b00=data.frame(age65=0,gender='0',hr85=0,cvd='0',miord='0',mitype='0')
df_b10=data.frame(age65=0,gender='0',hr85=0,cvd='0',miord='1',mitype='0')
df_b01=data.frame(age65=0,gender='0',hr85=0,cvd='0',miord='0',mitype='1')
df_b11=data.frame(age65=0,gender='0',hr85=0,cvd='0',miord='1',mitype='1')
```

```{r}
x_c00 <- survfit(mod_cox_b, newdata = df_b00)
x_c10 <- survfit(mod_cox_b, newdata = df_b10)
x_c01 <- survfit(mod_cox_b, newdata = df_b01)
x_c11 <- survfit(mod_cox_b, newdata = df_b11)
```


```{r}
fit <- list(IM00 = x_c00, IM10 = x_c10, IM01 = x_c01, IM11 = x_c11)
df_bc <- data.frame(rbind(df_b00,df_b10,df_b01,df_b11))
```



```{r}
library(reshape)
df_4 = data.frame(time=x_c00$time,
                  IM00=x_c00$surv,IM10=x_c10$surv,IM01=x_c01$surv,IM11=x_c11$surv)
df_4 = melt(df_4,id.vars = c("time"))
colnames(df_4) = c("time","IMcombi","S")
# pl_f <- ggplot(data=df_4) +
#           geom_line(aes(x=time,y=S,color=IMcombi))
# pl_f
```


```{r plCsbasalIM, fig.cap = "Supervivencia estimada para el modelo del apartado B), para cada tipo IM y orden IM (cuatro posibilidades): IM00:  miord=0, mitype=0, IM10: miord=1, mitype=0, IM01: miord=0, mitype=1, IM11: miord=1, mitype=1.", fig.width=5, fig.height=4}
ggsurvplot(fit, data = df_bc, combine = TRUE,
          censor = FALSE,
           legend.title="",
           ylab="Probabilidad de supervivencia, S",
           xlab="Tiempo",
            legend.labs = c("IM00", "IM10", "IM01", "IM11"),
           size = 0.1,
           font.legend = c(10),
           font.y = c(9),font.x = c(9),font.tickslab = c(9),
           xticks.by = -1)

```

A partir de la Figura \@ref(fig:plCsbasalIM) podeamos decir que el individuo categorizado como IM00 sería el mismo individuo tipo basal representado en el apartado C) (ver Figura \@ref(fig:plBsbasal)). Respecto a este individuo basal podemos ver que el caso IM11 y el caso IM10 estaría por debajo de la curva de supervivencia basal en todo el `Tiempo`. Sin embargo, el caso IM01 estaría por encima de la supervivencia del resto, incluido el individuo basal.

# D)

**A partir del apartado anterior, calculad la mediana y la probabilidad de supervivencia a un año para cada uno de los cuatro grupos. Interpretad los resultados.**

```{r comment=NA}
mediana=data.frame(cbind(IM00=summary(x_c00)$table['median'],
             IM10=summary(x_c10)$table['median'],
             IM01=summary(x_c01)$table['median'],
             IM11=summary(x_c11)$table['median']))
```

En la Tabla \@ref(tab:tDmedian)  mostramos el resultado de la medianas calculadas para cada tipo IM y orden IM (cuatro posibilidades): IM00:  miord=0, mitype=0, IM10: miord=1, mitype=0, IM01: miord=0, mitype=1, IM11: miord=1, mitype=1, vistos en el apartado C). A partir de estos resultados podemos comentar que las tres de los cuatro casos tienen la misma mediana, `r mediana$IM00` incluida la basal IM00. Al igual que se puede apreciar en la Figura \@ref(fig:plCsbasalIM), en la Tabla \@ref(tab:tDmedian) podemos ver que el caso con mayor mediana es el IM01, `r mediana$IM01`.

```{r tDmedian}
kable(mediana, booktabs = T, caption = "Mediana de la supervivencia estimada para el modelo del apartado B), para cada tipo IM y orden IM (cuatro posibilidades): IM00:  miord=0, mitype=0, IM10: miord=1, mitype=0, IM01: miord=0, mitype=1, IM11: miord=1, mitype=1.")
```


```{r}
day365 = df_4 %>% filter(time>365) %>% head(1)
df_4_365_hasta <- df_4 %>% filter(time <= day365$time)
```



```{r plCsbasalIM365_old, fig.cap = "Detalle hasta 365 días de la supervivencia estimada para el modelo del apartado B), para cada tipo IM y orden IM (cuatro posibilidades): IM00:  miord=0, mitype=0, IM10: miord=1, mitype=0, IM01: miord=0, mitype=1, IM11: miord=1, mitype=1.", fig.width=5, fig.height=4}
# pl_f <- ggplot(data=df_4_365_hasta) +
#           geom_line(aes(x=time,y=S,color=IMcombi)) +
#           labs(y="Probabilidad de supervivencias, S", x="Tiempo") +
#       theme(legend.position="top", plot.title = element_text(size = 10),
#           plot.caption = element_text(size = 8,color = "black", face = "italic"),
#           axis.title = element_text(size = 8), axis.text = element_text(size = 8),
#           panel.background = element_blank(),
#           axis.line = element_line(colour = "grey", size =0.5),
#           axis.ticks.length=unit(-0.1, "cm"),
#           axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
#           axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))
# pl_f
```

```{r plCsbasalIM365, fig.cap = "Detalle hasta 365 días de la supervivencia estimada para el modelo del B), para cada tipo IM y orden IM (cuatro posibilidades): IM00:  miord=0, mitype=0, IM10: miord=1, mitype=0, IM01: miord=0, mitype=1, IM11: miord=1, mitype=1.", fig.width=5, fig.height=4}
ggsurvplot(fit, data = df_bc, combine = TRUE,
          censor = FALSE,
           legend.title="",
           ylab="Probabilidad de supervivencia, S",
           xlab="Tiempo",
            legend.labs = c("IM00", "IM10", "IM01", "IM11"),
           size = 0.1,
           font.legend = c(10),
           font.y = c(9),font.x = c(9),font.tickslab = c(9),
          xlim = c(0, 360), ylim=c(0.8, 1),
           xticks.by = -1)


```

En este apartado, para hallar la supervivencia a 365 lo haremos de manera aproximada, ya que para realizar el ajuste de la estimación de supervivencia, el modelo semiparamétrico Cox utiliza métodos empíricos no distribucionales y representan la gráfica como una función por partes ('Step functions') [@KleinbaumDavidG2005Sa]. Por tanto, para ver la supervivencia a día 365, nos fijaremos en la supervivencia a día 365 o mayor, y diremos que esta se encontrara entre estos dos puntos. Por tanto, la supervivencia a 365 diremos que es aproximadamente (a Time= 368) lo representado en la tabla.

```{r}
df_4_365 <- df_4 %>% filter(time == day365$time)
kable(df_4_365, booktabs = T, caption = "Valores de supervivencia de las combinaciones IM a 365 días.")
```

# E)

**Depurar el modelo estimado en el apartado B) para que sólo contenga covariantes o interacciones de primer orden significativas. (Nota: aunque un efecto principal pudiera ser no significativo, lo mantendremos en el modelo siempre que intervenga en una interacción que sea significativa)**

Es este apartado, para depurar el modelo estimado en el apartado B), llevamos a cabo una estrategia "step forward". Para ello,
tomando el modelo del apartado B) como referencia, crearemos un primer modelo 'base' con todas sus covariantes y sobre él iremos añadiendo las posibles interacciones de primer orden existentes, siempre que estas interacciones aporten una variabilidad significativa en el modelo depurado que buscamos.

Para ver si la interacción aporta significancia en cada iteración del la función `f_step_forward` comprobamos si la interacción a introducir es significativa (`p-valor < 0.05`) realizaremos un test de ANOVA entre dos modelos: uno, el modelo depurado (obtenido hasta ese momento) y el otro, el modelo depurado con la nueva interacción añadida en esa iteración de la función `f_step_forward` implementada.

De este primer paso sacaremos un modelo candidato del cual analizaremos sus covariantes y eliminaremos aquellas que sean no significativas y que sus interacciones con otras covariantes sean también no significativas.

A continuación mostramos la implementación de la función `f_step_forward` con la que llevaremos a cavo esta primera estrategia de depuración. Cabe señalar, que esta función servirá para la depuración del modelo Cox del presente apartado I), así como para la depuración del modelo Weibull en el apartado H).

```{r echo=TRUE}
f_step_forward <- function(groupvars, df_, m){
  groupcomb <- combn(groupvars, 2, FUN=paste, collapse='*')
  n_tot= length(groupvars)+length(groupcomb)
  
  formul0 = as.formula(paste(measurevar, paste(groupvars, collapse=" + "), sep=" ~ "))
  if(m=="weibull"){
    mod_wei_g0 = survreg(formul0, data=df_, dist="weibull")  
  }else{
    mod_wei_g0 = coxph(formul0, data=df_, method="breslow")
  }
  
  best_pars = ""
  best_mod = mod_wei_g0
  for(new_par in groupcomb){

    base =  paste0(paste(groupvars, collapse=" + "))
    base_combi = paste0(base,best_pars,"+",new_par)
    
    formul = as.formula(paste(measurevar, base_combi, sep=" ~ "))
    if(m=="weibull"){
      mod_wei_g <- survreg(formul, data=df_, dist="weibull")
      mod_sum = summary(mod_wei_g)
      new_par_pvalue = mod_sum$table[length(mod_wei_g$coefficients),4]
    }else{
      mod_wei_g = coxph(formul, data=df_, method="breslow")
      mod_sum = summary(mod_wei_g)
      new_par_pvalue = coef(mod_sum)[length(mod_wei_g$coefficients),5]
    }
    

    if(new_par_pvalue < 0.05 ){
        #print(paste0(names(mod_wei_g$coefficients)[length(mod_wei_g$coefficients)],
        #             ": ",new_par_pvalue))
        #comprobamos anova
        check_a = anova(best_mod,mod_wei_g)
        if(m=="weibull"){
          if(check_a$`Pr(>Chi)`[2] < 0.05 ){
            best_pars = paste0(best_pars,"+",new_par)
            best_mod = mod_wei_g
            #print(paste0("best_pars",": ",check_a$`Pr(>Chi)`[2]," df=",
            #             (length(mod_wei_g$coefficients)-1)))
          }else{
            FALSE
            #print(paste0("out ",new_par))
          }
        }else{
          if(check_a$`P(>|Chi|)`[2] < 0.05 ){
            best_pars = paste0(best_pars,"+",new_par)
            best_mod = mod_wei_g
            #print(paste0("best_pars",": ",check_a$`Pr(>Chi)`[2]," df=",
            #             (length(mod_wei_g$coefficients)-1)))
          }else{
            FALSE
            #print(paste0("out ",new_par))
          }
        }
    }
    
  }

  return(best_mod)
}

```

Las covariantes que tomaremos para el primer modelo como base son: `gender`, `age65`, `hr85`, `miord` y `mitype`.

```{r}
measurevar <- "Y"
groupvars <- c("gender","age65","hr85","miord","mitype")
```

```{r comment=NA}
m="otros"
df_=df_b
mod = f_step_forward(groupvars,df_b,m)
```

Tras ejecutar la función `f_step_forward` e ir probando las diferentes interacciones, nos quedamos con las interacciones significativas de primer orden, y la fórmula del modelo es la siguiente:

```{r comment=NA}
mod$formula
#formula_extract <- paste( c(mod$formula[[2]], " ~ ", mod$formula[[3]]), collapse='')
#print(formula_extract)

```

```{r}
mod_cox_e_res = summary(mod)
```

En la Tabla \@ref(tab:tEcoxdepu), mostramos los resultados del modelo Cox que estamos depurando. Tras este primer paso de  depuración, vemos que todas las covariantes introducidas en el modelo son significativas exceptuando la covariante `gender` y `mitype`. 

```{r tEcoxdepu}
kable(mod_cox_e_res$coefficients, booktabs = T, caption = "Resultados del modelo Cox en depuración con las covarariantes del apartado E).")
```


```{r}
kable(data.frame(Likelihood=mod_cox_e_res$logtest), booktabs = T, caption = "Estadístico Likelihood del modelo Cox en depuración con las covarariantes del apartado E).")
```

Por tanto, de este primer paso descartaremos la covariante `mitype`, incluida en el primer modelo base. Sin embargo, la covariante `gender` no la descartamos del modelo depurado ya que su interacción con la covariante `age` sí que resulta significativa.

A continuación, calcularemos el modelo con las siguientes covariantes e interacciones: `gende`, `age65`, `hr85`, `miord`, `gender * age65` y `age65 * miord`.

```{r comment=NA}
mod_cox_depu=coxph(Y~gender + age65 + hr85 + miord + 
                     gender*age65 + age65*miord,
                   data=df_b, method="breslow")
```

```{r}
mod_cox_depu_e_res = summary(mod_cox_depu)
```

```{r tEcoxdepufin}
kable(mod_cox_depu_e_res$coefficients, booktabs = T, caption = "Resultados del modelo Cox depurado final del apartado E).")
```

```{r tEcoxdepufincoef}
kable(data.frame(Likelihood=mod_cox_depu_e_res$logtest), booktabs = T, caption = "Estadístico Likelihood del modelo Cox depurado final del apartado E).")
```

Hacemos un test Anova para comprobar que efectivamente la variable `mitype` no resulta significativa para el modelo final. 
```{r comment=NA}
mod_cox_depu$formula
```


```{r}
test_anova_e = anova(mod_cox_depu,mod)
p_value_anova_e = (test_anova_e$`P(>|Chi|)`)[2]
```

El `p-valor` `r p_value_anova_e` `< 0.05` nos indica que con el modelo sin la covariante `mitype` mejora el ajuste significativamente respecto al modelo con la covariante `mitype`. Por tanto, este modelo (ver Tabla \@ref(tab:tEcoxdepufin)) con todas sus covariantes e interacciones significativas depurado será el modelo depurado final de este apartado E).


# F)

**Verificar (usando todas las técnicas propuestas en el Capítulo 4 de KK12) la hipótesis de riesgos proporcionales para cada covariante en el modelo estimado en el apartado anterior. Interpretad y remodelizad si hace falta.**

A continuación utilizaremos las técnicas gráficas Log-log y Observados frente a Esperados, y también la técnica estadística bondad del ajuste (GOF: the goodness of fit) para verificar la hipótesis de riesgos proporcionales para cada covariante del modelo del apartado anterior.

* Gráficas Log-Log

La estrategia que vamos a seguir en el actual apartado para verificar la asunción de la hipótesis de riesgos proporcionales, es la de considerar una variable cada vez [@KleinbaumDavidG2005Sa]. Por tanto, para cada variable comprobaremos para cada categoría de la misma, si las curvas transformadas Log-Log de supervivencia estimada, Log-Log $\hat S$ son paralelas o si se cruzan.

Por ello, definimos la transformación $Log-Log \hat{S}$ como $-ln(-ln\hat{S})$ [@KleinbaumDavidG2005Sa].

Para automatizar y facilitar el uso de la transformación mencionada arriba, implementamos la función `f_loglog` que se muestra a continuación:

```{r echo=TRUE}
f_loglog <-function(km,param){

  df_s = data.frame(summary(km)$strata,summary(km)$time,summary(km)$surv)
  colnames(df_s) = c("param","time","s")
  df_s <- df_s %>% 
                mutate(param=factor(ifelse(grepl("0", param),0,1))) %>%
                mutate(loglog =-log(-log(s))) %>%
                mutate(type="0")
  colnames(df_s) = c(param,"time","s_obs","S_loglog","type")
  
  return(df_s)

}
```

Si las curvas que graficamos son aproximadamente paralelas concluiremos que la asunción de riesgos proporcionales se satisface para la variable analizada. Cabe señalar que las variables continuas; `age65` y `hr` las caracterizaremos  siguiendo lo aconsejado en la literatura (ver [@KleinbaumDavidG2005Sa]) y convertiremos en variables de dos categorías:

```{r echo=TRUE}
df_f <- df_b %>%
          mutate(
            age65_g = factor(ifelse(age65 < 0, 0, 1)),
            hr85_g = factor(ifelse(hr85 < 0, 0, 1)),
          )
```

```{r}
mod_cox_f <- mod_cox_depu
```

La estimación de supervivencia, $\hat{S}$ para cada variable la hallaremos con método de Kaplan-Meir mediante la función `survfit` y después transformaremos $\hat{S}$ mediante la función `f_loglog`.

```{r echo=TRUE}
km_g = survfit(Y ~ gender, df_f)
df_s_o_g <- f_loglog(km_g,"gender")

km_m = survfit(Y ~ miord, df_f)
df_s_o_m <- f_loglog(km_m,"miord")

km_a = survfit(Y ~ age65_g, df_f)
df_s_o_a <- f_loglog(km_a,"age65_g")

km_h = survfit(Y ~ hr85_g, df_f)
df_s_o_h <- f_loglog(km_h,"hr85_g")
```

```{r }
pl_f_g <- ggplot(data=df_s_o_g) +
  geom_line(aes(x=time,y=S_loglog,color=gender)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_m <- ggplot(data=df_s_o_m) +
  geom_line(aes(x=time,y=S_loglog,color=miord)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_a <- ggplot(data=df_s_o_a) +
  geom_line(aes(x=time,y=S_loglog,color=age65_g)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_h <- ggplot(data=df_s_o_h) +
  geom_line(aes(x=time,y=S_loglog,color=hr85_g)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))
```

En la Figura \@ref(fig:plFloglog) vemos las covariables del modelo con los valores transformados de supervivencia estimada $log-log\hat{S}$ vemos de manera bastante clara que las curvas son bastante paralelas y no se cruzan.

```{r plFloglog, fig.cap = "Supervivencia estimada transformada Log-Log S para las covariantes: gender, miord, age65_g y hr85_g  en modelo del apartado E).", fig.width=8, fig.height=6}
pl_f <- ggarrange(pl_f_g, pl_f_m, pl_f_a, pl_f_h, common.legend = FALSE, legend = "top", ncol=2,nrow=2)
print (pl_f)
```

No obstante, en la Figura \@ref(fig:plFloglogZoom) mostramos las curvas haciendo "zoom" para ver a mayor detalle en el tiempo inicial. Si fijamos con más detalle, en Tiempo inicial vemos que las curvas para todas las covariantes se cruzan salvo la variable `age65_g`. Esta observación no la tomamos como relevante, debido a que ocurre al principio de la curva y puede ser debido a que no existen demasiadas observaciones. Por lo demás, si nos fijamos en la parte central de la curva, vemos sí se cumple el supuesto de riesgos proporcionales para las covariables: `gender`, `miord`, `age65_g`, y `h85_g`.

```{r}
pl_f_g <- ggplot(data=df_s_o_g) +
  geom_line(aes(x=time,y=S_loglog,color=gender)) +
  scale_x_continuous(limits = c(0,30)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_m <- ggplot(data=df_s_o_m) +
  geom_line(aes(x=time,y=S_loglog,color=miord)) +
  scale_x_continuous(limits = c(0,30)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_a <- ggplot(data=df_s_o_a) +
  geom_line(aes(x=time,y=S_loglog,color=age65_g)) +
  scale_x_continuous(limits = c(0,30)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_h <- ggplot(data=df_s_o_h) +
  geom_line(aes(x=time,y=S_loglog,color=hr85_g)) +
  scale_x_continuous(limits = c(0,30)) +
          labs(y="Log-Log S", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))
```

```{r plFloglogZoom, fig.cap = "Detalle de la supervivencia estimada transformada Log-Log S para las covariantes: gender, miord, age65_g y hr85_g en modelo del apartado E).", fig.width=8, fig.height=6}

pl_f <- ggarrange(pl_f_g, pl_f_m, pl_f_a, pl_f_h, common.legend = FALSE, legend = "top", ncol=2,nrow=2)
print (pl_f)
```




* Gráficas Observado vs. Esperado 

En este subapartado enfrentaremos los valores observados de supervivencia calculados en el subapartado anterior por Kaplan-Meier con los valores de esperados calculados a continuación mediante la técnica de Cox.


A continuación mostramos la función `f_cox_pred` para obtener los predicciones de supervivencia:

```{r echo=TRUE}
f_cox_pred <-function(mod_cox_f,param){
  
  df_f_g0=data.frame('0')
  colnames(df_f_g0) <- c(param)
  df_f_g1=data.frame('1')
  colnames(df_f_g1) <- c(param)
  
  x_f_g0 <- survfit(mod_cox_f, newdata = df_f_g0)
  x_f_g1 <- survfit(mod_cox_f, newdata = df_f_g1)
  s_f_g0 = summary(x_f_g0)$surv
  s_f_g1 = summary(x_f_g1)$surv
  t_f_g0 = summary(x_f_g0)$time
  t_f_g1 = summary(x_f_g1)$time
  
  
  df_s_pred =data.frame(rbind(cbind("0",t_f_g0,s_f_g0),cbind("1",t_f_g1,s_f_g1)),"1")
  colnames(df_s_pred) = c(param,"time","s_pred","type")
  df_s_pred <- df_s_pred %>% mutate(time=as.numeric(time),s_pred=as.numeric(s_pred))
  
  return(df_s_pred)
  
}
```

```{r}
mod_cox_f_g = coxph(Y~gender, df_f, method="breslow")
df_s_p_g <- f_cox_pred(mod_cox_f_g,param="gender")

mod_cox_f_m =coxph(Y~miord, df_f, method="breslow")
df_s_p_m <- f_cox_pred(mod_cox_f_m,p="miord")

mod_cox_f_a = coxph(Y~age65_g, df_f, method="breslow")
df_s_p_a <- f_cox_pred(mod_cox_f_a,p="age65_g")

mod_cox_f_h = coxph(Y~hr85_g, df_f, method="breslow")
df_s_p_h <- f_cox_pred(mod_cox_f_h,p="hr85_g")
```

```{r}
pl_f_c_o <- ggplot() +
  geom_line(aes(x=time,y=s_obs,color=gender) ,data=df_s_o_g) +
  geom_line(aes(x=time,y=s_pred,color=gender) ,data=df_s_p_g,linetype = "dashed") +
          labs(y="S observada vs esperada", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_c_m <- ggplot() +
  geom_line(aes(x=time,y=s_obs,color=miord) ,data=df_s_o_m) +
  geom_line(aes(x=time,y=s_pred,color=miord) ,data=df_s_p_m,linetype = "dashed") +
          labs(y="S observada vs esperada", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_c_a <- ggplot() +
  geom_line(aes(x=time,y=s_obs,color=age65_g) ,data=df_s_o_a) +
  geom_line(aes(x=time,y=s_pred,color=age65_g) ,data=df_s_p_a,linetype = "dashed") +
          labs(y="S observada vs esperada", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))

pl_f_c_h <- ggplot() +
  geom_line(aes(x=time,y=s_obs,color=hr85_g) ,data=df_s_o_h) +
  geom_line(aes(x=time,y=s_pred,color=hr85_g) ,data=df_s_p_h,linetype = "dashed") +
          labs(y="S observada vs esperada", x="Tiempo")  +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))
```

Como podemos ver en la Figura \@ref(fig:plFsobsespe), de manera general parece que las curvas de supervivencia observadas-esperada están bastante alineadas en todas las covariantes. Cabe destacar, que en covarinte `age65_g` se desvían un poco ambas curvas sobre todo para `age65_g` (individuos < 65 años). Por tanto, parece que sí se cumple para estas covariantes el supuesto de riesgos proporcionales.

```{r plFsobsespe, fig.cap = "Supervivencia observada vs. esperada para las covariantes: gender, miord, age65_g y hr85_g en modelo del apartado E).", fig.width=8, fig.height=6}

pl_f <- ggarrange(pl_f_c_o, pl_f_c_m, pl_f_c_a, pl_f_c_h, common.legend = FALSE, legend = "top", ncol=2,nrow=2)
print (pl_f)
```

* Test de la bondad de ajuste. GOF (the goodness of fit)

Mediante este test calculamos un estadístico y el `p-valor` que nos permite examinar si se cumple la asunción realizada sobre los riesgos proporcionales. De esta manera complementaremos con este estadístico los visto en los subapartados anteriores mediante las gráficas. La idea que subyace sobre este estadístico es que los residuos de Schoenfel para la variable no están relacionados con el tiempo de supervivencia [@KleinbaumDavidG2005Sa].

```{r tFgof}
tt = cox.zph(mod_cox_f,transform = rank)
kable(tt$table, booktabs = T, caption = "Correlación entre los residuos de Schoenfeld y las covariantes.")
```

Según la Tabla \@ref(tab:tFgof), si nos fijamos en el `p-valor < 0.05`, no hay evidencia significativa para rechazar la asunción de riesgos relativos de ninguna de las covariantes, incluido el global aunque para este último por poco.

```{r fig.width=8, fig.height=6}
#ggcoxdiagnostics(mod_cox_f, type = "schoenfeld")
```

En la Figura \@ref(fig:plFgof) podemos analizar la relación entre los residuos de Schoenfeld frente al Tiempo de "fallo" de cada individuo. De cumplirse la asunción de riesgos proporcionales la curva ajustada debería de verse horizontal porque los residuos de Schoenfeld serían independientes al Tiempo de supervivencia [@KleinbaumDavidG2005Sa]. De las covariantes analizadas, vemos que  en `hr85` existe cierta curvatura que estaría contradiciendo dicha asunción. Sin embargo, le damos más peso al resultado obtenido por el estadístico (ver Tabla \@ref(tab:tFgof),) y decidimos dejar la covariante como parte del modelo final del apartado F).

```{r plFgof, fig.cap = "Correlación entre los residuos de Schoenfeld y el Tiempo de 'fallo' de cada individuo.", fig.width=8, fig.height=8}
par(mfrow = c(3, 2))
plot(cox.zph(mod_cox_f,transform = rank),se=T,var="age65")
plot(cox.zph(mod_cox_f,transform = rank),se=T,var="age65:miord")
plot(cox.zph(mod_cox_f,transform = rank),se=T,var="gender")
plot(cox.zph(mod_cox_f,transform = rank),se=T,var="gender:age65")
plot(cox.zph(mod_cox_f,transform = rank),se=T,var="hr85")
plot(cox.zph(mod_cox_f,transform = rank),se=T,var="miord")
```

```{r tFgoff}
# mod_cox_ff = coxph(Y~gender + age65 + miord + 
#                      gender*age65 + age65*miord,
#                    data=df_b, method="breslow")
# tt = cox.zph(mod_cox_ff,transform = rank)
# kable(tt$table, booktabs = T, caption = "Correlación entre los residuos de Schoenfeld y las covariantes")
```




# G)

**Estimad e interpretad un modelo Weibull sin interacciones (o exponencial, si es más adecuado) para nuestro tiempo de interés que incluya las siguientes covariantes como efectos principales: gender, age (centrada en 65), hr (centrada en 85), chf, diasbp y bm.**

```{r}
df_g <- df_orig %>%
  mutate(age65=age-65,
         hr85=hr-85) %>%
  select(gender,age65,hr85,chf,diasbp,bmi,fstat,lenfol)
```

A continuación realizamos la modelización del las variables mencionadas con las distribución Exponencial:

```{r echo=TRUE}
mod_exp_g <- survreg(Surv(lenfol,fstat) ~ gender + age65 + hr85 + chf + diasbp + bmi,
                     data=df_g, dist="exponential")
```


En la Tabla \@ref(tab:tGexpo) mostramos los estadísticos calculados para cada covariante y vemos que todos las covariantes son significativas.

```{r tGexpo}
tt_exp_g <- summary(mod_exp_g)
kable(tt_exp_g$table, booktabs = T, caption = "Resultado del modelo paramétrico Exponencial ajustado con las covarinates: gender, age65, hr85, chf, diasbp, bmi.")
```

En la Tabla \@ref(tab:tGtexpo) vemos los parámetros de la distribución Exponencial con los que se ha realizado el ajuste.

```{r tGtexpo}
kable(data.frame(param=cbind(mod_exp_g$icoef)), booktabs = T, caption = "Parámetros del modelo Exponencial ajustado con las covarinates: gender, age65, hr85, chf, diasbp, bmi.")
```

A continuación realizamos la modelización del las variables mencionadas con las distribución Weibull:

```{r}
mod_wei_g <- survreg(Surv(lenfol,fstat) ~ gender + age65 + hr85 + chf + diasbp + bmi,
                     data=df_g, dist="weibull")
```

En la Tabla \@ref(tab:tGtweibull) mostramos los estadísticos calculados para cada covariante y en la Tabla \@ref(tab:tGtweibullcoef)   mostramos los parámetros de la distribución Weibull. Vemos que todos las covariantes son significativos menos `gender`.

```{r tGtweibull}
tt_wei_g <- summary(mod_wei_g)
kable(tt_wei_g$table, booktabs = T, caption = "Resultado del modelo Weibull ajustado con las covarinates: gender, age65, hr85, chf, diasbp, bmi.")
```

```{r tGtweibullcoef}
kable(data.frame(param=cbind(mod_wei_g$icoef)), booktabs = T, caption = "Parámetros del modelo Weibull ajustado con las covarinates: gender, age65, hr85, chf, diasbp, bmi.")
```

A continuación realizaremos un análisis de la varianza mediante un test ANOVA entre el modelo Exponencial y el modelo Weibull. De esta manera analizaremos ambos modelos con la intención de quedarnos con el modelo que sea más parsimonioso.

```{r}
test_anova_g = anova(mod_exp_g, mod_wei_g)
p_value_anova_g = (test_anova_g$`Pr(>Chi)`)[2]
```

El `p-valor` = `r p_value_anova_g` $< 0.05$ nos indica que con el modelo Weibull sí mejora el ajuste significativamente respecto al modelo Exponencial.

# H)

**Incluid, si es significativo, el efecto de las interacciones de primer orden en el modelo anterior. Interpretad los resultados.**

```{r}
Y_h = Surv(df_g$lenfol,df_g$fstat)
measurevar <- "Y_h"
groupvars <- c("gender","age65","hr85","chf","diasbp","bmi")
groupcomb <- combn(groupvars, 2, FUN=paste, collapse='*')
n_tot= length(groupvars)+length(groupcomb)
```

Al igual que en el apartado E) hacemos uso de la función `f_step_forward` para partiendo de las covariantes utilizadas en el apartado G) depurar un modelo que utilizando las posibles interacciones entre covariantes podamos quedarnos con el modelo que provea el ajuste más parsimonioso a los datos.


```{r echo=TRUE, comment=NA}
m="weibull"
df_h=df_g
mod_wei_h_depu = f_step_forward(groupvars,df_h,m)
```


En la Tabla \@ref(tab:tHtweibulldepu) mostramos los estadísticos calculados para cada covariante, en la Tabla \@ref(tab:tHweibulllike) el estadístico Likelihood, y en la Tabla \@ref(tab:tHtweibulldepucoef) los parámetros de la distribución Weibull depurada. Vemos que todos las covariantes son significativos menos `gender`, sin embargo, como la iteración `gender*age65` sí que es significativa la dejaremos como parte del modelo.

```{r tHtweibulldepu}
tt_wei_h <- summary(mod_wei_h_depu)
kable(tt_wei_h$table, booktabs = T, caption = "Resultado del modelo paramétrico Weibull ajustado depurado final del apartado H).")
```

```{r tHtweibulldepucoef}
kable(data.frame(param=cbind(mod_wei_h_depu$icoef)), booktabs = T, caption = "Parámetros del modelo paramétrico Weibull depurado final del apartado H).")
```


```{r tHweibulllike}
mod_wei_h_depu_res = summary(mod_wei_h_depu)
kable(data.frame(Likelihood=mod_wei_h_depu_res$loglik), booktabs = T, caption = "Estadístico Likelihood del modelo Weibull depurado final del apartado H).")
```

# I)

**Estimad el modelo de Cox con interacciones de primer orden, si es significativo, con las covariantes del modelo en g). Comparar gráficamente las predicciones y discutid los resultados obtenidos entre el modelo estimado en h) con el resultado de la modelización semiparamétrica del modelo de Cox de este apartado.**

```{r}
df_i = df_g
```


```{r}
Y_i = Surv(df_i$lenfol,df_i$fstat)
measurevar <- "Y_i"
groupvars <- c("gender","age65","hr85","chf","diasbp","bmi")
groupcomb <- combn(groupvars, 2, FUN=paste, collapse='*')
```

Al igual que en el apartado E) hacemos uso de la función `f_step_forward`, de manera que partiendo de las covariantes utilizadas en el apartado H) depuraremos el modelo hasta llegar al más parsimonioso teniendo en cuenta las posibles interacciones de las covariantes elegidas.

```{r echo=TRUE, comment=NA}
m="Cox"
df_i=df_g
mod_cox_i_depu = f_step_forward(groupvars,df_i,m)
```

En la Tabla \@ref(tab:tIcox) mostramos los estadísticos calculados para cada covariante.

```{r tIcox}
tt_cox_i <- summary(mod_cox_i_depu)
kable(tt_cox_i$coefficients, booktabs = T, caption = "Resultados del modelo Cox con interacciones de primer orden significativas, con las covariantes del modelo en I)")
```

En la Tabla \@ref(tab:tIstats) mostramos los resultados del estadístico para el modelo ajustado y vemos que tenemos un buen ajuste con un `p-valor < 0.05`.

```{r tIstats}
mod_cox_i_depu_res = summary(mod_cox_i_depu)

kable(data.frame(Likelihood=mod_cox_i_depu_res$logtest), booktabs = T, caption = "Estadístico Likelihood del modelo Cox con las variables del apartado H).")
```

Las covariantes y la interacción utilizada que componen el modelo final son las mismas que en el modelo Weibull calculado en el apartado H). No obstante los coeficientes de estas covariantes son diferentes (ver Tabla \@ref(tab:tIcoxcoeff)).

```{r tIcoxcoeff}
kable(data.frame(coef=cbind(mod_cox_i_depu$coefficients)), booktabs = T, caption = "Coeficientes del modelo Cox del apartado H).")
```

En el modelo Weibull además de las covariantes y la interacción tenemos el intercepto (ver Tabla \@ref(tab:tIstats)).

```{r tIweicoeff}
kable(data.frame(coef=cbind(mod_wei_h_depu$coefficients)), booktabs = T, caption = "Coeficientes del modelo Weibull.")
```

Para realizar la estimación de probabilidad de supervivencia, S, con ambos modelo hemos utilizado un individuo tipo: `gender=1`, `hr85=0`, `chf=0`, `chf=0` y para las variables continuas `diasbp` y `bmi` hemos utilizado su mediana.

```{r}
df_basal_i = data.frame(gender='0', age65=0, hr85=0, chf=0, diasbp=median(df_i$diasbp), bmi=median(df_i$bmi))
pct=0:100/100
t_wei = predict(mod_wei_h_depu,newdata=df_basal_i,type="quantile",p=pct) 
df_wei_i = data.frame(time = t_wei, s_wei=1-pct)
```

```{r}
s_cox_i <- survfit(mod_cox_i_depu, newdata = df_basal_i)
df_cox_i <- data.frame(time=summary(s_cox_i)$time,s_cox=summary(s_cox_i)$surv)
```

A continuación, en la Figura \@ref(fig:plsweicox), en la comparativa de la probabilidad de supervivencia, S, estimada con el modelo Weibull y el modelo Cox, vemos que ambas estimaciones se asemejan bastante, sobre todo en la parte central de la curva. Si bien cabe destacar cierta diferencia al final del `Tiempo`, donde el modelo Weibull presenta una bajada brusca, menos escalonada que el modelo Cox. Cabe destacar el modelo Cox se realiza con el supuesto de riesgos proporcionales (PH: Proportional Hazard), mientras que la modelo de Weibull se realiza mediante el supuesto de riesgos proporcionales y de fallos acelerados en el tiempo (AFT: Aceleration Failure Time)

```{r plsweicox, fig.cap = "Comparacion de la probabilidad de supervivencias, S, entre la el modelo Weibull y el modelo Cox con las covariantes: gender, age65, hr85, chf, diasbp, bmi y la interacción gender * age65.", fig.width=5, fig.height=4}
max_x = max(df_cox_i$time)
pl_wei_s_i <- ggplot() +
      geom_line(aes(x=time,y=s_wei,color="Weibull"),data=df_wei_i) + 
      geom_line(aes(x=time,y=s_cox,color="Cox"),data=df_cox_i) +
      scale_x_continuous(limits = c(0,max_x)) +
      scale_color_manual(values = c('Weibull' = 'black', 'Cox' = 'gray')) +
      labs(y="Probabilidad de supervivencia, S", x="Tiempo", colour='') +
      theme(legend.position="top", plot.title = element_text(size = 10),
          plot.caption = element_text(size = 8,color = "black", face = "italic"),
          axis.title = element_text(size = 8), axis.text = element_text(size = 8),
          panel.background = element_blank(),
          axis.line = element_line(colour = "grey", size =0.5),
          axis.ticks.length=unit(-0.1, "cm"),
          axis.text.x = element_text(margin=unit(c(2,0,0,0),"mm")),
          axis.text.y = element_text(margin=unit(c(0,2,0,0),"mm")))
pl_wei_s_i
```






# Anexos

En este apartado incluimos una referencia mediante un enlace a github (repositorio web de código), donde se puede consultar y descargar el código `R` utilizado en el presente trabajo.



# References

\mbox{~}






















